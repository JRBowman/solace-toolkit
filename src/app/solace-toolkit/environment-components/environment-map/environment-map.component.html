<solacetk-model-list [(model)]="model" moduleName="Environment Maps" modelUri="Environments/Maps"
    (modelLoaded)="loadEditor()">

    <div class="editor">
        <img cdkDrag class="sprite-thumb-2col sprite auto-flex" [src]="profileUrl + '.png'" alt="map layer">
    </div>

    <div class="editor-actions">
        <div class="disp-flex auto-flex">
            <button mat-icon-button matTooltip="Import Aseprite File" (click)="textureUpload.click()">
                <mat-icon>upload</mat-icon>
            </button>
            <input type="file" class="file-input" (change)="onAseSelected($event)" accept=".ase,.aseprite"
                #textureUpload>
        </div>
    </div>

    <div class="editor-panels">
        <div class="auto-flex">

            <!-- Map Viewer Panel: -->
            <solacetk-panel [unitHeight]="12" class="auto-flex full-width" panelColor="#222034" panelName="Map Viewer"
                panelIcon="branding_watermark">

                <div class="panel-content full-height map-panel relative-container mat-elevation-z4"
                    style="height: 98%; background-color: rgb(24 23 36);">

                    <!-- <div class="full-height full-width" [style.paddingBottom]="((mapHeight - 32)) + 'px'"
                        [style.marginTop]="-((mapHeight - 16)) + 'px'" [style.marginLeft]="-((mapWidth - 16)) + 'px'"
                        [style.transform]="'scale(' + mapscale + ',' + mapscale + ')'"> -->

                    <!-- Scalable View Panel: -->
                    <div class="scroll-view full-height full-width" [style.transformOrigin]="'center'"
                        [style.transform]="mapscale > 1 ? 'scale(' + mapscale + ',' + mapscale + ')' : 'scale(1,1)'">

                        <!-- Working Area: -->
                        <div class="relative-input mat-elevation-z4" cdkDrag cdkDragBoundary=".scroll-view"
                            [cdkDragFreeDragPosition]="mapDragPos" [style.width]="mapWidth" [style.height]="mapHeight">

                            <div *ngFor="let layer of model.layers">
                                <img class="sprite map-layer auto-flex" *ngIf="layer.enabled"
                                    [src]="profileUrl + '-' + layer.name + '-0.png'" alt="map layer"
                                    [style.height]="mapHeight">
                            </div>

                            <!-- Tile / Cell -->
                            <!-- [style.background]="'url(' + gridUrl + ')'" -->
                            <div *ngIf="selectedMode" class="full-width full-height">
                                <div matRipple class="gridCell background-grid" *ngFor="let tile of tiles"
                                    [style.backgroundColor]="showCellColors ? tile.groupColorKey : ''"
                                    [style.left]="tile.x * 16 + 'px'" [style.top]="tile.y * 16 + 'px'"
                                    (click)="SelectCell(tile)" style="opacity: 0.667;" [class.mat-elevation-z2]="tile.selected"
                                    [class.gridSelected]="tile.selected"
                                    [matTooltip]="(tile.name ?? 'Cell') +  ' - [' + tile.x + ', ' + tile.y + ']'">
                                </div>
                            </div>
                            <!-- </div> -->
                        </div>
                    </div>

                    <!-- Relative Zoom Text: -->
                    <small class="relative-input font-large"
                        style="right: 16px; bottom: 24px; color: darkgray; text-shadow: 1px 2px 4px #000000c7;">x{{mapscale}}</small>

                    <!-- Relative Zoom Slider: -->
                    <div class="relative-input mat-elevation-z4"
                        style="bottom: 8px; left: 12%; right: 12%; background-color: #2f4f4fd2; border-radius: 32px; padding-left: 16px; padding-right: 16px;">

                        <div class="disp-flex auto-flex">
                            <mat-slider class="auto-flex" max="16" min="0.25" step="0.25" showTickMarks="true">
                                <input matSliderThumb [(ngModel)]="mapscale">
                            </mat-slider>
                        </div>
                    </div>

                    <!-- Relative Map Layers Panel: -->
                    <div class="relative-input width-8 min-width-3" style="right: 8px; top: 8px;">
                        <!-- <map-layers-panel fontSize="small" panelName="Map Layers" panelIcon="layers"
                            panelColor="#208060E0" [(model)]="model.layers" panelType="expansionpanel"
                            [(selectedInstance)]="selectedLayer">
                        </map-layers-panel> -->
                        <solacetk-panel fontSize="small" panelType="expansionpanel" panelName="Map Layers"
                            panelIcon="layers" panelColor="#208060E0">
                            <div class="expansionpanel-content">
                                <mat-chip-listbox multiple="true" style="place-content: space-evenly;">
                                    <mat-chip-option [selected]="instance.enabled"
                                        class="font-xsmall auto-flex full-width" *ngFor="let instance of model.layers"
                                        (click)="instance.enabled = !instance.enabled">
                                        {{instance.name}}
                                    </mat-chip-option>
                                </mat-chip-listbox>
                            </div>
                        </solacetk-panel>
                    </div>

                    <!-- Relative Cell Panel: -->
                    <solacetk-panel *ngIf="selectedMode == 'cell'" class="relative-input width-6 min-width-4"
                        panelColor="#606080E0" panelName="Cell" panelIcon="table_view" style="left: 8px; top: 8px;">
                        <div class="panel-content">

                            <div class="" *ngIf="selectedCell">

                                <!-- Cell Model: -->
                                <div class="disp-flex">
                                    <div class="gap-1 no-flex"></div>
                                    <mat-form-field class="auto-flex font-small width-8">
                                        <mat-label class="font-small">PosX</mat-label>
                                        <input matInput placeholder="Position X" [(ngModel)]="selectedCell.x" disabled>
                                    </mat-form-field>
                                    <div class="gap-1 no-flex"></div>
                                    <mat-form-field class="auto-flex font-small width-8">
                                        <mat-label class="font-small">PosY</mat-label>
                                        <input matInput placeholder="Position Y" [(ngModel)]="selectedCell.y" disabled>
                                    </mat-form-field>
                                    <div class="gap-1 no-flex"></div>

                                    <!-- <div class="disp-flex"> -->
                                    <mat-form-field class="auto-flex font-small">
                                        <mat-label class="font-small">Name</mat-label>
                                        <input matInput placeholder="Name" [(ngModel)]="selectedCell.name">
                                    </mat-form-field>
                                </div>
                            </div>

                        </div>
                        <div class="panel-actions disp-flex full-width" *ngIf="selectedCell">
                            <div class="gap-1 auto-flex"></div>

                            <mat-form-field class="no-flex font-small align-center"
                                style="opacity: 0; width: 0; height: 0;">
                                <mat-icon matPrefix class="align-center" [style.color]="selectedCell.groupColorKey">
                                    radar
                                </mat-icon>
                                <mat-label class="font-small">Group</mat-label>
                                <input matInput #groupColorKey placeholder="Group Color Key" type="color"
                                    [(ngModel)]="selectedCell.groupColorKey" [value]="selectedCell.groupColorKey">
                            </mat-form-field>

                            <button mat-icon-button matTooltip="Set Group Key" (click)="groupColorKey.click()">
                                <mat-icon [style.color]="selectedCell.groupColorKey">
                                    radar
                                </mat-icon>
                            </button>


                            <div class="gap-2 no-flex"></div>

                            <button mat-icon-button matTooltip="Save Cell Data" (click)="CenterMap()">
                                <mat-icon>save</mat-icon>
                            </button>
                        </div>
                    </solacetk-panel>

                </div>

                <div class="panel-actions full-width">

                    <div class="disp-flex auto-flex">

                        <button mat-icon-button matTooltip="Toggle Cell/Chunk Colors"
                            (click)="showCellColors = !showCellColors">
                            <mat-icon>invert_colors</mat-icon>
                        </button>

                        <div class="gap-1 no-flex"></div>

                        <div class="disp-flex auto-flex" *ngIf="selectedMode != 'view'">

                            <button mat-icon-button matTooltip="Deselect Cells" (click)="DeselectCells()">
                                <mat-icon>border_clear</mat-icon>
                            </button>

                            <div class="gap-1 no-flex"></div>

                            <div class="disp-flex auto-flex" *ngIf="selectedMode == 'chunk'">
                                <mat-form-field class="no-flex font-small align-center"
                                    style="opacity: 0; width: 0; height: 0;">
                                    <mat-icon matPrefix class="align-center" [style.color]="chunkColor">
                                        radar
                                    </mat-icon>
                                    <mat-label class="font-small">Group</mat-label>
                                    <input matInput #chunkPixelColor placeholder="Group Color Key" type="color"
                                        [(ngModel)]="chunkColor" [value]="chunkColor">
                                </mat-form-field>

                                <button mat-icon-button matTooltip="Set Group Key" (click)="chunkPixelColor.click()">
                                    <mat-icon [style.color]="chunkColor">
                                        radar
                                    </mat-icon>
                                </button>

                                <div class="gap-1 no-flex"></div>

                                <button *ngIf="selectedCells && selectedCells.length > 0" mat-icon-button
                                    matTooltip="Create Chunk from Selected" (click)="CreateChunk()">
                                    <mat-icon [style.color]="chunkColor">dataset_linked</mat-icon>
                                </button>

                                <button *ngIf="selectedCells && selectedCells.length > 0" mat-icon-button
                                    matTooltip="Clear Chunk from Selected" (click)="ClearChunk()">
                                    <mat-icon [style.color]="'#c06020'">check_box_outline_blank</mat-icon>
                                </button>
                            </div>

                        </div>

                        <div class="gap-1 auto-flex"></div>

                        <button mat-icon-button matTooltip="Center Map" (click)="CenterMap()">
                            <mat-icon>center_focus_strong</mat-icon>
                        </button>

                        <div class="gap-1 no-flex"></div>

                        <mat-button-toggle-group class="full-height" [(value)]="selectedMode"
                            (change)="ModeChange($event)">
                            <mat-button-toggle value="view" aria-label="View Mode">
                                <mat-icon>preview</mat-icon>
                            </mat-button-toggle>
                            <mat-button-toggle value="cell" aria-label="Cell Mode">
                                <mat-icon>table_view</mat-icon>
                            </mat-button-toggle>
                            <mat-button-toggle value="chunk" aria-label="Chunk Mode">
                                <mat-icon>dataset</mat-icon>
                            </mat-button-toggle>
                        </mat-button-toggle-group>



                        <!-- <button mat-button matTooltip="Log Model to Console" (click)="logModel()">
                            Log
                        </button> -->
                    </div>
                </div>

            </solacetk-panel>

            <div class="gap-1 no-flex"></div>

            <div class="disp-flex">

                <!-- Selected Cell Panel: -->
                <solacetk-panel class="auto-flex width-33" panelColor="#606080" panelName="Cell" panelIcon="table_view"
                    panelType="expansionpanel">
                    <div class="expansionpanel-content">

                        <div class="" *ngIf="selectedCell">

                            <!-- Cell Model: -->
                            <div class="disp-flex">
                                <mat-form-field class="no-flex font-small width-8">
                                    <mat-label class="font-small">Id</mat-label>
                                    <input matInput placeholder="Id" [(ngModel)]="selectedCell.id" disabled>
                                </mat-form-field>
                                <div class="gap-1 no-flex"></div>
                                <mat-form-field class="no-flex font-small width-8">
                                    <mat-label class="font-small">PosX</mat-label>
                                    <input matInput placeholder="Position X" [(ngModel)]="selectedCell.x" disabled>
                                </mat-form-field>
                                <div class="gap-1 no-flex"></div>
                                <mat-form-field class="no-flex font-small width-8">
                                    <mat-label class="font-small">PosY</mat-label>
                                    <input matInput placeholder="Position Y" [(ngModel)]="selectedCell.y" disabled>
                                </mat-form-field>
                                <div class="gap-1 no-flex"></div>
                                <mat-form-field class="no-flex font-small align-center"
                                    style="opacity: 0; width: 0; height: 0;">
                                    <mat-icon matPrefix class="align-center" [style.color]="selectedCell.groupColorKey">
                                        radar
                                    </mat-icon>
                                    <mat-label class="font-small">Group</mat-label>
                                    <input matInput #selectedGroupColorKey placeholder="Group Color Key" type="color"
                                        [(ngModel)]="selectedCell.groupColorKey" [value]="selectedCell.groupColorKey">
                                </mat-form-field>

                                <button mat-icon-button matTooltip="Set Group Key"
                                    (click)="selectedGroupColorKey.click()">
                                    <mat-icon [style.color]="selectedCell.groupColorKey">
                                        radar
                                    </mat-icon>
                                </button>
                                <div class="gap-1 no-flex"></div>
                                <!-- <div class="disp-flex"> -->
                                <mat-form-field class="auto-flex font-small">
                                    <mat-label class="font-small">Name</mat-label>
                                    <input matInput placeholder="Name" [(ngModel)]="selectedCell.name">
                                </mat-form-field>
                            </div>

                            <!-- </div> -->

                            <!-- Cell Data: -->
                            <solacetk-attributes-panel class="auto-flex" [panelMode]="1"
                                [panelName]="selectedCell.name + ' Data'" panelType="expansionpanel"
                                [(model)]="selectedCell.downstreamData">
                            </solacetk-attributes-panel>

                            <div class="gap-1 no-flex"></div>

                            <solacetk-event-panel [(model)]="selectedCell.events"></solacetk-event-panel>


                        </div>
                    </div>
                    <div class="expansionpanel-actions" *ngIf="selectedCell">
                        <button mat-icon-button matTooltip="Save Cell Data" (click)="CenterMap()">
                            <mat-icon>save</mat-icon>
                        </button>
                    </div>
                </solacetk-panel>

                <div class="gap-1 no-flex"></div>

                <!-- Map Layers Panel: -->
                <div class="auto-flex width-6">
                    <map-layers-panel fontSize="medium" panelName="Map Layers" panelIcon="layers" panelColor="#208060"
                        overflowMethod="inherit" [(model)]="model.layers" [(selectedInstance)]="selectedLayer"
                        panelType="expansionpanel" [showActions]="true">
                    </map-layers-panel>
                </div>

            </div>

            <div class="gap-1 no-flex"></div>

            <!-- Tileset Editor: -->
            <solacetk-panel class="auto-flex width-2" panelColor="#c08060" panelName="Tile Set" panelIcon="grid_view">
                <div class="panel-content">
                </div>
                <div class="panel-actions">
                </div>
            </solacetk-panel>

        </div>
    </div>

</solacetk-model-list>